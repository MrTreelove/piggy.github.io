# 用户认证与登录技术方案

### 项目资料

需求prd链接：piggy需求/需求/用户认证与授权-规格故事.md

技术方案链接：piggy需求/需求/用户认证与登录技术方案.md

计划发布日期：2025-01-27

PD人员：待定

开发人员：待定

测试人员：待定

### 需求价值

实现用户注册、登录、登出、密码管理和数据隔离功能，确保用户数据安全和隐私，为Piggy记账应用提供安全的用户认证与授权基础。

### 需求分析

在Piggy记账应用中，用户需要注册账号并登录后才能使用应用。系统需要实现完整的用户认证与授权机制，包括：
1. 用户注册：支持用户名/邮箱注册，密码强度验证，防止重复注册
2. 用户登录：支持用户名/邮箱登录，登录失败锁定机制，记住登录状态
3. 用户登出：安全清除会话和令牌
4. 密码管理：修改密码、忘记密码重置
5. 数据隔离：确保每个用户只能访问自己的数据，所有API请求必须验证用户身份

### 术语解释

| 术语 | 解释 | 举个栗子 |
| ------- | ------------------------------------------------------ | ----------- |
| JWT | JSON Web Token，用于身份验证的开放标准 | 用户登录后获得的访问令牌 |
| BCrypt | 密码哈希算法，用于安全存储密码 | 用户密码加密存储 |
| 访问令牌 | 短期有效的身份验证令牌 | 有效期2小时 |
| 刷新令牌 | 长期有效的令牌，用于刷新访问令牌 | 有效期30天 |
| 会话 | 用户登录后建立的会话信息 | 包含用户ID、设备信息等 |
| 数据隔离 | 确保用户只能访问自己的数据 | 所有查询自动添加user_id过滤 |

### 业务实体

对应三层架构的数据层，职责：ORM映射，持久化实体。

| 实体 | 属性及类型<br>（默认varchar类型） | 索引键 | 字段值说明 |
| ------------------- | -------------------------------------------------------------------------------- | ------------------------------------------------ | -------------------------------- |
| 用户(User) | 1. 用户ID：bigint<br>2. 用户名：varchar(50)<br>3. 邮箱：varchar(100)<br>4. 密码哈希：varchar(255)<br>5. 创建时间：datetime<br>6. 更新时间：datetime<br>7. 最后登录时间：datetime<br>8. 账户锁定时间：datetime<br>9. 登录失败次数：int<br>10. 状态：tinyint | 1. 用户ID（主键）<br>2. 用户名（唯一索引）<br>3. 邮箱（唯一索引） | 1. 状态：0-正常，1-锁定，2-禁用 |
| 会话(Session) | 1. 会话ID：bigint<br>2. 用户ID：bigint<br>3. 访问令牌：varchar(500)<br>4. 刷新令牌：varchar(500)<br>5. 设备信息：varchar(200)<br>6. IP地址：varchar(50)<br>7. 创建时间：datetime<br>8. 访问令牌过期时间：datetime<br>9. 刷新令牌过期时间：datetime<br>10. 状态：tinyint | 1. 会话ID（主键）<br>2. 用户ID（索引）<br>3. 访问令牌（唯一索引）<br>4. 刷新令牌（唯一索引） | 1. 状态：0-有效，1-已登出，2-已过期 |
| 密码重置令牌(PasswordResetToken) | 1. 令牌ID：bigint<br>2. 用户ID：bigint<br>3. 重置令牌：varchar(100)<br>4. 创建时间：datetime<br>5. 过期时间：datetime<br>6. 是否已使用：tinyint | 1. 令牌ID（主键）<br>2. 用户ID（索引）<br>3. 重置令牌（唯一索引） | 1. 是否已使用：0-未使用，1-已使用 |

### 领域功能

对应三层架构的业务逻辑层，职责：封装领域内业务逻辑和业务规则，沉淀业务知识，遵守领域内开闭原则。

| 领域 | 领域服务 | 领域功能 | 功能描述 | 规则约束 |
| ------ | ---------- | -------- | ----------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| 用户认证 | 用户注册 | 注册用户 | 创建新用户账号：<br>1. 验证用户名/邮箱唯一性<br>2. 验证密码强度（至少8位，包含字母和数字）<br>3. 使用BCrypt加密密码<br>4. 创建用户记录 | 1. 用户名不能重复<br>2. 邮箱不能重复<br>3. 密码必须至少8位，包含字母和数字<br>4. 密码使用BCrypt加密存储 |
| | 用户登录 | 验证登录 | 验证用户登录凭据：<br>1. 根据用户名/邮箱查询用户<br>2. 验证密码<br>3. 检查账户是否锁定<br>4. 更新登录失败次数或重置失败次数<br>5. 创建会话并生成令牌 | 1. 连续5次登录失败后锁定账户30分钟<br>2. 登录成功后重置失败次数<br>3. 账户锁定期间不允许登录 |
| | | 刷新令牌 | 刷新访问令牌：<br>1. 验证刷新令牌有效性<br>2. 生成新的访问令牌<br>3. 更新会话信息 | 1. 刷新令牌必须有效且未过期<br>2. 访问令牌有效期2小时<br>3. 刷新令牌有效期30天 |
| | 用户登出 | 登出用户 | 清除用户会话：<br>1. 标记会话为已登出<br>2. 使令牌失效 | 1. 登出后令牌立即失效<br>2. 已登出的会话不能再次使用 |
| | 密码管理 | 修改密码 | 修改用户密码：<br>1. 验证当前密码<br>2. 验证新密码强度<br>3. 使用BCrypt加密新密码<br>4. 更新用户密码<br>5. 清除所有会话（可选） | 1. 当前密码必须正确<br>2. 新密码必须符合强度要求<br>3. 新密码不能与当前密码相同 |
| | | 生成重置令牌 | 生成密码重置令牌：<br>1. 根据邮箱查询用户<br>2. 生成唯一的重置令牌<br>3. 创建密码重置令牌记录 | 1. 邮箱必须已注册<br>2. 重置令牌有效期24小时<br>3. 重置令牌只能使用一次 |
| | | 重置密码 | 使用重置令牌重置密码：<br>1. 验证重置令牌有效性<br>2. 验证新密码强度<br>3. 使用BCrypt加密新密码<br>4. 更新用户密码<br>5. 标记重置令牌为已使用<br>6. 清除所有会话 | 1. 重置令牌必须有效且未过期<br>2. 重置令牌只能使用一次<br>3. 新密码必须符合强度要求 |
| 权限验证 | 权限验证 | 验证用户身份 | 从JWT令牌中提取用户ID：<br>1. 验证令牌签名<br>2. 验证令牌过期时间<br>3. 验证会话状态<br>4. 返回用户ID | 1. 令牌签名必须有效<br>2. 令牌不能过期<br>3. 会话必须有效 |
| | | 验证数据所有权 | 验证用户对资源的访问权限：<br>1. 获取资源的user_id<br>2. 与当前用户ID比较<br>3. 返回验证结果 | 1. 资源的user_id必须与当前用户ID一致<br>2. 不匹配时返回403错误 |

### 应用服务

对应三层架构的应用层，职责：对外提供服务接口，调用领域服务，跨领域组装业务流程，模型转换，必要的参数校验、事务及异常处理。

| 服务域 | 服务接口 | 服务方法 | 方法流程描述 | 校验约束 |
| ------ | ---------- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- |
| 用户认证 | 用户注册服务 | 注册 | 1. 参数校验（用户名/邮箱、密码）<br>2. 调用领域服务验证唯一性和密码强度<br>3. 调用领域服务创建用户<br>4. 返回注册结果 | 1. 用户名/邮箱必填，长度限制<br>2. 密码必填，符合强度要求<br>3. 用户名和邮箱不能同时为空 |
| | 用户登录服务 | 登录 | 1. 参数校验（用户名/邮箱、密码）<br>2. 调用领域服务验证登录<br>3. 调用领域服务创建会话<br>4. 返回访问令牌和刷新令牌 | 1. 用户名/邮箱必填<br>2. 密码必填<br>3. 记住登录状态为可选参数 |
| | | 刷新令牌 | 1. 参数校验（刷新令牌）<br>2. 调用领域服务刷新令牌<br>3. 返回新的访问令牌 | 1. 刷新令牌必填 |
| | 用户登出服务 | 登出 | 1. 从请求头获取访问令牌<br>2. 调用领域服务验证用户身份<br>3. 调用领域服务清除会话<br>4. 返回登出结果 | 1. 访问令牌必填<br>2. 用户必须已登录 |
| | 密码管理服务 | 修改密码 | 1. 参数校验（当前密码、新密码）<br>2. 调用领域服务验证用户身份<br>3. 调用领域服务修改密码<br>4. 返回修改结果 | 1. 当前密码必填<br>2. 新密码必填，符合强度要求<br>3. 用户必须已登录 |
| | | 申请重置密码 | 1. 参数校验（邮箱）<br>2. 调用领域服务生成重置令牌<br>3. 发送重置邮件<br>4. 返回申请结果 | 1. 邮箱必填，格式正确<br>2. 邮箱必须已注册 |
| | | 重置密码 | 1. 参数校验（重置令牌、新密码）<br>2. 调用领域服务验证重置令牌<br>3. 调用领域服务重置密码<br>4. 返回重置结果 | 1. 重置令牌必填<br>2. 新密码必填，符合强度要求 |
| 权限验证 | 权限验证服务 | 验证权限 | 1. 从请求头获取访问令牌<br>2. 调用领域服务验证用户身份<br>3. 返回用户ID | 1. 访问令牌必填<br>2. 令牌必须有效 |

### 接口定义

以下定义了各服务的接口规范：

#### 用户认证接口

##### 1. 用户注册

**说明**: 创建新用户账号

- **请求方法**: POST
- **请求路径**: /api/auth/register

**请求参数**:

| 参数名称 | 类型   | 是否必填 | 说明     |
| -------- | ------ | -------- | -------- |
| username | String | 否       | 用户名（用户名和邮箱至少填写一个） |
| email    | String | 否       | 邮箱（用户名和邮箱至少填写一个） |
| password | String | 是       | 密码（至少8位，包含字母和数字） |

**响应结果**:

| 参数名称 | 类型   | 说明     |
| -------- | ------ | -------- |
| userId   | Long   | 用户ID   |
| username | String | 用户名   |
| email    | String | 邮箱     |
| message  | String | 提示信息 |

##### 2. 用户登录

**说明**: 用户登录系统，获取访问令牌

- **请求方法**: POST
- **请求路径**: /api/auth/login

**请求参数**:

| 参数名称       | 类型    | 是否必填 | 说明                     |
| -------------- | ------- | -------- | ------------------------ |
| usernameOrEmail | String  | 是       | 用户名或邮箱             |
| password       | String  | 是       | 密码                     |
| rememberMe     | Boolean | 否       | 记住登录状态（默认false） |

**响应结果**:

| 参数名称     | 类型            | 说明                     |
| ------------ | --------------- | ------------------------ |
| accessToken  | String          | 访问令牌                 |
| refreshToken | String          | 刷新令牌                 |
| expiresIn    | Long            | 访问令牌过期时间（秒）   |
| user         | UserResponse    | 用户信息                 |
| &nbsp;&nbsp;&nbsp;&nbsp;userId   | Long            | 用户ID                   |
| &nbsp;&nbsp;&nbsp;&nbsp;username | String          | 用户名                   |
| &nbsp;&nbsp;&nbsp;&nbsp;email    | String          | 邮箱                     |

##### 3. 刷新访问令牌

**说明**: 使用刷新令牌获取新的访问令牌

- **请求方法**: POST
- **请求路径**: /api/auth/refresh

**请求参数**:

| 参数名称     | 类型   | 是否必填 | 说明     |
| ------------ | ------ | -------- | -------- |
| refreshToken | String | 是       | 刷新令牌 |

**响应结果**:

| 参数名称    | 类型   | 说明                   |
| ----------- | ------ | ---------------------- |
| accessToken | String | 新的访问令牌           |
| expiresIn   | Long   | 访问令牌过期时间（秒） |

##### 4. 用户登出

**说明**: 用户登出系统，清除会话

- **请求方法**: POST
- **请求路径**: /api/auth/logout

**请求参数**:

无（从请求头Authorization获取访问令牌）

**请求头**:

| 参数名称      | 类型   | 是否必填 | 说明           |
| ------------- | ------ | -------- | -------------- |
| Authorization | String | 是       | Bearer {token} |

**响应结果**:

| 参数名称 | 类型   | 说明     |
| -------- | ------ | -------- |
| message  | String | 提示信息 |

##### 5. 修改密码

**说明**: 已登录用户修改密码

- **请求方法**: POST
- **请求路径**: /api/auth/change-password

**请求参数**:

| 参数名称       | 类型   | 是否必填 | 说明                     |
| -------------- | ------ | -------- | ------------------------ |
| currentPassword | String | 是       | 当前密码                 |
| newPassword    | String | 是       | 新密码（至少8位，包含字母和数字） |

**请求头**:

| 参数名称      | 类型   | 是否必填 | 说明           |
| ------------- | ------ | -------- | -------------- |
| Authorization | String | 是       | Bearer {token} |

**响应结果**:

| 参数名称 | 类型   | 说明     |
| -------- | ------ | -------- |
| message  | String | 提示信息 |

##### 6. 申请重置密码

**说明**: 忘记密码时申请重置密码链接

- **请求方法**: POST
- **请求路径**: /api/auth/forgot-password

**请求参数**:

| 参数名称 | 类型   | 是否必填 | 说明     |
| -------- | ------ | -------- | -------- |
| email    | String | 是       | 注册邮箱 |

**响应结果**:

| 参数名称 | 类型   | 说明     |
| -------- | ------ | -------- |
| message  | String | 提示信息 |

##### 7. 重置密码

**说明**: 使用重置令牌重置密码

- **请求方法**: POST
- **请求路径**: /api/auth/reset-password

**请求参数**:

| 参数名称    | 类型   | 是否必填 | 说明                     |
| ----------- | ------ | -------- | ------------------------ |
| token       | String | 是       | 密码重置令牌             |
| newPassword | String | 是       | 新密码（至少8位，包含字母和数字） |

**响应结果**:

| 参数名称 | 类型   | 说明     |
| -------- | ------ | -------- |
| message  | String | 提示信息 |

##### 8. 验证令牌

**说明**: 验证访问令牌有效性，获取用户信息

- **请求方法**: GET
- **请求路径**: /api/auth/verify

**请求参数**:

无（从请求头Authorization获取访问令牌）

**请求头**:

| 参数名称      | 类型   | 是否必填 | 说明           |
| ------------- | ------ | -------- | -------------- |
| Authorization | String | 是       | Bearer {token} |

**响应结果**:

| 参数名称 | 类型   | 说明   |
| -------- | ------ | ------ |
| userId   | Long   | 用户ID |
| username | String | 用户名 |
| email    | String | 邮箱   |

#### 统一响应格式

所有接口的响应格式遵循以下规范：

```json
{
  "code": 200,
  "message": "success",
  "data": {}, // 具体的业务数据
  "success": true
}
```

#### 统一错误码

| 错误码 | 说明                 |
| ------ | -------------------- |
| 200    | 请求成功             |
| 400    | 请求参数错误         |
| 401    | 未授权（未登录或令牌无效） |
| 403    | 禁止访问（无权限）   |
| 404    | 资源不存在           |
| 409    | 资源冲突（如用户名/邮箱已存在） |
| 423    | 账户已锁定           |
| 500    | 服务器内部错误       |

### 服务依赖

| 依赖域 | 依赖POM | 依赖服务签名 | 依赖服务版本<br>（HSF类型服务填） | 强/弱依赖 | 方法入参说明<br>（无特殊情况不用填） | 方法出参说明<br>（无特殊情况不用填） | 接入示例 |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------- | --------------------------------- | --------- | ------------------------------------ | ------------------------------------ | ------------------------------------ |
| 邮件服务 | 待定 | 发送邮件接口 | 待定 | 弱依赖 | 收件人邮箱、邮件主题、邮件内容 | 发送结果 | 用于发送密码重置邮件 |

### 技术实现要点

#### 1. 关键业务逻辑

**1.1 密码加密存储**
- 使用BCrypt算法对密码进行哈希加密，成本因子设置为12
- 每次加密生成不同的盐值，确保相同密码的哈希值不同
- 密码验证时使用BCrypt的verify方法，避免明文密码存储

**1.2 JWT令牌生成与验证**
- 访问令牌包含用户ID、用户名、过期时间等信息
- 使用HS256算法签名，密钥存储在配置文件中
- 访问令牌有效期2小时，刷新令牌有效期30天
- 令牌刷新时生成新的访问令牌，刷新令牌保持不变

**1.3 登录失败锁定机制**
- 使用Redis或数据库记录用户登录失败次数
- 连续5次失败后锁定账户30分钟
- 锁定期间所有登录尝试直接拒绝
- 登录成功后重置失败次数

**1.4 数据隔离实现**
- 所有业务表必须包含user_id字段
- 在数据访问层（DAO）统一添加user_id过滤条件
- 使用拦截器或AOP在Service层自动注入当前用户ID
- 资源访问时验证资源的所有权（user_id匹配）

#### 2. 关键业务规则

**2.1 密码强度规则**
- 至少8位字符
- 必须包含至少一个字母
- 必须包含至少一个数字
- 可以包含特殊字符（可选）

**2.2 账户锁定规则**
- 连续5次登录失败触发锁定
- 锁定时间30分钟（可配置）
- 锁定期间不允许登录
- 锁定时间到期后自动解锁

**2.3 令牌过期规则**
- 访问令牌过期后需要刷新
- 刷新令牌过期后需要重新登录
- 令牌刷新时验证刷新令牌的有效性

**2.4 数据访问规则**
- 所有需要认证的接口必须验证令牌
- 所有数据查询必须添加user_id过滤
- 资源访问必须验证所有权
- 未授权访问返回401或403错误

#### 3. 数据一致性

**3.1 用户注册事务**
- 用户注册必须在事务中完成
- 如果用户名或邮箱已存在，回滚事务
- 确保用户记录完整创建

**3.2 密码修改事务**
- 密码修改必须在事务中完成
- 验证当前密码正确性
- 更新密码后清除所有会话（可选）

**3.3 密码重置事务**
- 生成重置令牌和发送邮件应在事务中完成
- 重置密码时标记令牌为已使用
- 确保令牌只能使用一次

#### 4. 扩展性

**4.1 多设备登录支持**
- 支持同一用户在多设备同时登录
- 每个设备生成独立的会话和令牌
- 记录设备信息用于安全审计

**4.2 令牌黑名单机制**
- 登出时将令牌加入黑名单
- 使用Redis存储黑名单，设置过期时间
- 验证令牌时检查黑名单

**4.3 邮箱验证扩展**
- 预留邮箱验证功能接口
- 用户注册后可选择邮箱验证
- 未验证邮箱可限制部分功能

#### 5. 可维护性

**5.1 统一异常处理**
- 定义统一的异常码和异常信息
- 使用全局异常处理器统一处理
- 记录详细的错误日志

**5.2 安全日志记录**
- 记录所有认证相关操作（登录、登出、密码修改等）
- 记录登录失败尝试和账户锁定事件
- 记录异常访问尝试

**5.3 配置化管理**
- 密码强度规则可配置
- 账户锁定规则可配置
- 令牌过期时间可配置

### 风险评估

#### 1. 性能风险

**1.1 密码加密性能**
- **风险**：BCrypt加密计算成本较高，高并发下可能影响性能
- **影响**：用户注册和登录响应时间可能增加
- **缓解措施**：
  - 使用异步处理密码加密（注册时）
  - 优化BCrypt成本因子（平衡安全性和性能）
  - 使用连接池优化数据库连接

**1.2 令牌验证性能**
- **风险**：每次API请求都需要验证JWT令牌，高并发下可能成为瓶颈
- **影响**：API响应时间可能增加
- **缓解措施**：
  - 使用Redis缓存已验证的令牌
  - 优化JWT验证算法
  - 使用负载均衡分散请求

**1.3 数据库查询性能**
- **风险**：所有查询都添加user_id过滤，可能影响查询性能
- **影响**：数据查询响应时间可能增加
- **缓解措施**：
  - 在user_id字段上建立索引
  - 优化查询语句，避免全表扫描
  - 使用数据库连接池

#### 2. 并发风险

**2.1 重复注册风险**
- **风险**：多个请求同时使用相同用户名/邮箱注册
- **影响**：可能创建重复用户
- **缓解措施**：
  - 使用数据库唯一索引
  - 在应用层使用分布式锁
  - 使用乐观锁或悲观锁

**2.2 登录失败计数并发**
- **风险**：并发登录失败时，失败次数计数可能不准确
- **影响**：账户锁定机制可能失效
- **缓解措施**：
  - 使用Redis原子操作（INCR）计数
  - 使用分布式锁保护计数操作
  - 使用数据库行锁

**2.3 令牌刷新并发**
- **风险**：同时刷新令牌可能生成多个有效令牌
- **影响**：安全风险，可能导致令牌泄露
- **缓解措施**：
  - 使用分布式锁保护刷新操作
  - 每次刷新使旧令牌失效
  - 限制刷新频率

#### 3. 资损风险

**3.1 密码重置令牌泄露**
- **风险**：重置令牌被恶意获取，可能导致账户被攻击
- **影响**：用户账户安全风险
- **缓解措施**：
  - 重置令牌使用强随机数生成
  - 重置令牌只能使用一次
  - 重置令牌有效期限制为24小时
  - 记录所有密码重置操作日志

**3.2 令牌泄露风险**
- **风险**：访问令牌或刷新令牌被泄露
- **影响**：攻击者可能冒充用户访问系统
- **缓解措施**：
  - 使用HTTPS传输令牌
  - 令牌存储在HttpOnly Cookie中（Web端）
  - 实现令牌黑名单机制
  - 支持用户主动撤销所有令牌

#### 4. 依赖稳定性风险

**4.1 邮件服务依赖**
- **风险**：邮件服务不可用，密码重置功能失效
- **影响**：用户无法重置密码
- **缓解措施**：
  - 使用消息队列异步发送邮件
  - 实现邮件发送重试机制
  - 提供备用邮件服务
  - 记录邮件发送失败日志，支持人工处理

**4.2 数据库依赖**
- **风险**：数据库不可用，所有认证功能失效
- **影响**：用户无法登录和使用系统
- **缓解措施**：
  - 使用数据库主从复制
  - 实现数据库连接池和重试机制
  - 监控数据库健康状态

#### 5. 安全风险

**5.1 SQL注入风险**
- **风险**：用户输入未正确转义，可能导致SQL注入
- **影响**：数据库被攻击，数据泄露
- **缓解措施**：
  - 使用参数化查询
  - 使用ORM框架（如MyBatis）
  - 输入验证和转义
  - 定期安全审计

**5.2 XSS攻击风险**
- **风险**：用户输入未正确转义，可能导致XSS攻击
- **影响**：前端页面被攻击
- **缓解措施**：
  - 输入验证和转义
  - 使用CSP（内容安全策略）
  - 输出编码

**5.3 暴力破解风险**
- **风险**：攻击者尝试大量密码组合登录
- **影响**：账户可能被破解
- **缓解措施**：
  - 实现登录失败锁定机制
  - 使用验证码（连续失败后）
  - 限制登录频率（IP级别）
  - 记录异常登录尝试

**5.4 令牌重放攻击**
- **风险**：攻击者截获令牌后重复使用
- **影响**：未授权访问
- **缓解措施**：
  - 令牌设置合理的过期时间
  - 实现令牌黑名单
  - 使用HTTPS传输
  - 记录令牌使用日志

### 测试用例

#### 1. 功能测试

**1.1 用户注册测试**
- **用例1.1.1**：正常注册流程
  - **前置条件**：用户未注册
  - **操作步骤**：使用有效的用户名、邮箱和符合强度要求的密码注册
  - **预期结果**：注册成功，返回用户信息，可以立即登录

- **用例1.1.2**：用户名重复注册
  - **前置条件**：用户名已存在
  - **操作步骤**：使用已存在的用户名注册
  - **预期结果**：注册失败，返回"用户名已存在"错误

- **用例1.1.3**：邮箱重复注册
  - **前置条件**：邮箱已存在
  - **操作步骤**：使用已存在的邮箱注册
  - **预期结果**：注册失败，返回"邮箱已存在"错误

- **用例1.1.4**：密码强度不足
  - **前置条件**：用户未注册
  - **操作步骤**：使用不符合强度要求的密码（如少于8位、无数字、无字母）注册
  - **预期结果**：注册失败，返回密码强度要求提示

- **用例1.1.5**：用户名和邮箱同时为空
  - **前置条件**：用户未注册
  - **操作步骤**：用户名和邮箱都为空时注册
  - **预期结果**：注册失败，返回参数校验错误

**1.2 用户登录测试**
- **用例1.2.1**：正常登录流程
  - **前置条件**：用户已注册
  - **操作步骤**：使用正确的用户名/邮箱和密码登录
  - **预期结果**：登录成功，返回访问令牌和刷新令牌

- **用例1.2.2**：密码错误登录
  - **前置条件**：用户已注册
  - **操作步骤**：使用错误的密码登录
  - **预期结果**：登录失败，返回"用户名或密码错误"，失败次数+1

- **用例1.2.3**：账户锁定测试
  - **前置条件**：用户已注册，连续4次登录失败
  - **操作步骤**：第5次使用错误密码登录
  - **预期结果**：登录失败，账户被锁定30分钟，返回"账户已锁定"提示

- **用例1.2.4**：锁定期间登录尝试
  - **前置条件**：账户已被锁定
  - **操作步骤**：尝试使用正确密码登录
  - **预期结果**：登录失败，返回"账户已锁定，请稍后再试"

- **用例1.2.5**：记住登录状态
  - **前置条件**：用户已注册
  - **操作步骤**：勾选"记住登录状态"并使用正确凭据登录
  - **预期结果**：登录成功，刷新令牌有效期30天

- **用例1.2.6**：不记住登录状态
  - **前置条件**：用户已注册
  - **操作步骤**：不勾选"记住登录状态"并使用正确凭据登录
  - **预期结果**：登录成功，刷新令牌有效期较短（如7天）

**1.3 用户登出测试**
- **用例1.3.1**：正常登出流程
  - **前置条件**：用户已登录
  - **操作步骤**：调用登出接口
  - **预期结果**：登出成功，会话被清除，令牌失效

- **用例1.3.2**：登出后访问受保护资源
  - **前置条件**：用户已登出
  - **操作步骤**：使用之前的令牌访问需要认证的API
  - **预期结果**：返回401未授权错误

**1.4 密码管理测试**
- **用例1.4.1**：正常修改密码
  - **前置条件**：用户已登录
  - **操作步骤**：输入正确的当前密码和符合强度要求的新密码
  - **预期结果**：密码修改成功，可以使用新密码登录

- **用例1.4.2**：当前密码错误
  - **前置条件**：用户已登录
  - **操作步骤**：输入错误的当前密码
  - **预期结果**：密码修改失败，返回"当前密码错误"

- **用例1.4.3**：新密码强度不足
  - **前置条件**：用户已登录
  - **操作步骤**：输入符合要求的当前密码，但新密码不符合强度要求
  - **预期结果**：密码修改失败，返回密码强度要求提示

- **用例1.4.4**：申请密码重置
  - **前置条件**：用户已注册但忘记密码
  - **操作步骤**：输入注册邮箱申请重置密码
  - **预期结果**：重置链接发送成功，返回提示信息

- **用例1.4.5**：使用重置令牌重置密码
  - **前置条件**：已收到密码重置邮件
  - **操作步骤**：使用有效的重置令牌和符合强度要求的新密码重置
  - **预期结果**：密码重置成功，可以使用新密码登录

- **用例1.4.6**：重置令牌过期
  - **前置条件**：重置令牌已过期（超过24小时）
  - **操作步骤**：使用过期的重置令牌重置密码
  - **预期结果**：重置失败，返回"链接已过期，请重新申请"

- **用例1.4.7**：重置令牌重复使用
  - **前置条件**：重置令牌已使用过一次
  - **操作步骤**：再次使用相同的重置令牌
  - **预期结果**：重置失败，返回"链接已失效"

**1.5 数据隔离测试**
- **用例1.5.1**：用户A查询自己的数据
  - **前置条件**：用户A和用户B都已注册并登录
  - **操作步骤**：用户A查询账户列表
  - **预期结果**：仅返回用户A的账户，不包含用户B的账户

- **用例1.5.2**：用户A访问用户B的资源
  - **前置条件**：用户A和用户B都已登录，用户B有账户ID=100
  - **操作步骤**：用户A尝试访问账户ID=100
  - **预期结果**：返回403禁止访问错误

- **用例1.5.3**：未登录用户访问受保护资源
  - **前置条件**：用户未登录
  - **操作步骤**：尝试访问需要认证的API
  - **预期结果**：返回401未授权错误

#### 2. 非功能测试

**2.1 性能测试**
- **用例2.1.1**：注册性能测试
  - **测试场景**：100个并发用户同时注册
  - **预期结果**：95%的请求响应时间小于1秒，无错误

- **用例2.1.2**：登录性能测试
  - **测试场景**：1000个并发用户同时登录
  - **预期结果**：99%的请求响应时间小于500毫秒，无错误

- **用例2.1.3**：令牌验证性能测试
  - **测试场景**：10000次/秒的令牌验证请求
  - **预期结果**：99%的请求响应时间小于100毫秒

**2.2 兼容性测试**
- **用例2.2.1**：不同浏览器兼容性
  - **测试场景**：在Chrome、Safari、Firefox、Edge浏览器测试登录功能
  - **预期结果**：所有浏览器都能正常登录

- **用例2.2.2**：不同设备兼容性
  - **测试场景**：在PC、手机、平板设备测试
  - **预期结果**：所有设备都能正常使用

**2.3 可靠性测试**
- **用例2.3.1**：数据库故障恢复
  - **测试场景**：模拟数据库故障，然后恢复
  - **预期结果**：系统能够自动重连，功能恢复正常

- **用例2.3.2**：令牌过期处理
  - **测试场景**：访问令牌过期后尝试访问API
  - **预期结果**：返回401错误，提示刷新令牌

- **用例2.3.3**：网络中断恢复
  - **测试场景**：注册过程中网络中断，然后恢复
  - **预期结果**：数据一致性保持，不会创建不完整用户

**2.4 安全测试**
- **用例2.4.1**：SQL注入测试
  - **测试场景**：在用户名字段输入SQL注入代码
  - **预期结果**：输入被正确转义，不会执行SQL注入

- **用例2.4.2**：XSS攻击测试
  - **测试场景**：在输入字段输入XSS攻击代码
  - **预期结果**：输入被正确转义，不会执行XSS攻击

- **用例2.4.3**：暴力破解防护测试
  - **测试场景**：连续尝试1000次不同密码登录
  - **预期结果**：账户被锁定，后续尝试被阻止

- **用例2.4.4**：令牌重放攻击测试
  - **测试场景**：使用已登出的令牌重复访问API
  - **预期结果**：返回401错误，令牌无法使用

**2.5 压力测试**
- **用例2.5.1**：高并发注册压力测试
  - **测试场景**：1000个并发用户同时注册
  - **预期结果**：系统稳定，无数据丢失，响应时间可接受

- **用例2.5.2**：高并发登录压力测试
  - **测试场景**：5000个并发用户同时登录
  - **预期结果**：系统稳定，无数据丢失，响应时间可接受

- **用例2.5.3**：长时间运行稳定性测试
  - **测试场景**：系统运行24小时，持续处理请求
  - **预期结果**：系统稳定，无内存泄漏，响应时间稳定

